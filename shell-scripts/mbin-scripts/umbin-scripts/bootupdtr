#!/bin/sh -e
. /usr/subr/out
trap 'echo "INTERRUPTED"; rm "$TMP"; exit 130' INT
TMP="$(mktemp /tmp/"$PROGN".XXX)"
NR=0
alias warn='pwarn "please check $TMP" && NR=1'
runcom() {
	printf "$1: "
	if $1 1>/dev/null 2>"$TMP"; then
		echo SUCC
	else
		echo FAIL
	fi
}


if [ "$1" = '--reinstall-grub' ]; then
	runcom reinstall-grub
fi

runcom 'mkinitcpio -P'
grep -Fqv '==> WARNING: Possibly missing firmware for module:' "$TMP" && warn

runcom 'grub-mkconfig -o /boot/grub/grub.cfg'
grep -Ev -e '^Warning: os-prober will not be executed to detect other bootable partitions\.$' \
	-e '^Systems on them will not be added to the GRUB boot configuration\.$' \
	-e '^Check GRUB_DISABLE_OS_PROBER documentation entry\.$' \
	-e '^Found (linux|initrd|fallback) image' \
	-e '^Generating grub configuration file \.\.\.$' \
	-e '^done$' "$TMP" && warn

[ $NR -eq 0 ] && rm "$TMP"
